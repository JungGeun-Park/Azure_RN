trigger:
- main

pool:
  name: APPSEALING

parameters:
- name: APPLE_ID
  type: string
  default: 'puzznic@inka.co.kr'
- name: APP_SPECIFIC_PASSWORD
  type: string
  default: 'qbrz-hmfz-robj-eohm'
- name: TEAM_ID
  type: string
  default: '22X77ENQ2H'
- name: PROVISIONING_PROFILE_NAME
  type: string
  default: 'AppSealing Wildcard Distribution Profile'

steps:
- script: |
    # Automatically detect the app name from the iOS directory
    IOS_PATH="ios"
    if [ -d "$IOS_PATH" ]; then
        APP_NAME=$(ls "$IOS_PATH" | grep ".xcodeproj" | sed 's/.xcodeproj//')
        if [ -z "$APP_NAME" ]; then
            echo "No Xcode project found in the iOS directory."
            exit 1
        fi
    else
        echo "iOS directory not found."
        exit 1
    fi

    echo "Detected app name: $APP_NAME"
    echo "##vso[task.setvariable variable=APP_NAME]$APP_NAME"
  displayName: 'Detect App Name'

- script: |
    # Define paths for provisioning profile and keychain setup
    P12_CERT_PATH="$(Build.SourcesDirectory)/ios/distribution.p12"
    PROVISIONING_PROFILE_PATH="$(Build.SourcesDirectory)/ios/profile.mobileprovision"
    KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"
    KEYCHAIN_PASSWORD="temp123"

    # Create a temporary keychain for code signing
    if security list-keychains | grep -q "temp-keychain.keychain-db"; then
        echo "Deleting existing temporary keychain..."
        security delete-keychain "$KEYCHAIN_PATH"
    fi

    echo "Creating temporary keychain..."
    security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

    echo "Setting temporary keychain as default..."
    security list-keychains -d user -s "$KEYCHAIN_PATH"
    security default-keychain -s "$KEYCHAIN_PATH"
    security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
    security set-keychain-settings -lut 3600 "$KEYCHAIN_PATH"

    echo "Importing distribution certificate (PKCS#12) into temporary keychain..."
    security import "$P12_CERT_PATH" -k "$KEYCHAIN_PATH" -P "123456" -T /usr/bin/codesign
    security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
  displayName: 'Setup Temporary Keychain and Install Certificate'

- task: NodeTool@0
  inputs:
    versionSpec: '18.x'  # React Nativeì™€ í˜¸í™˜ë˜ëŠ” ì•ˆì •ì ì¸ ë²„ì „ ì‚¬ìš©
  displayName: 'Install Node.js'

- script: |
    echo "Removing existing node_modules..."
    rm -rf node_modules
    rm -f package-lock.json

    echo "Reinstalling Node modules..."
    npm install --legacy-peer-deps

    echo "Verifying React Native scripts..."
    if [ -f "node_modules/react-native/scripts/react_native_pods.rb" ]; then
      echo "âœ… React Native scripts found!"
    else
      echo "âŒ React Native scripts missing! Attempting to restore..."
      npm audit fix --force
    fi
  displayName: 'Reinstall Node Modules'

- script: |
    export GEM_HOME=$HOME/.gem
    export PATH=$GEM_HOME/bin:$PATH
    
    echo "Installing CocoaPods..."
    gem install cocoapods --user-install
    
    echo "CocoaPods version:"
    export PATH=$HOME/.gem/ruby/*/bin:$PATH
    which pod || echo "Pod not found in PATH"
    pod --version || echo "Pod command not available"
  displayName: 'Install CocoaPods'

- script: |
    # First, detect the app name correctly
    APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
    echo "Detected app name: $APP_NAME"
    
    # Create Podfile with proper variable substitution
    cat > ios/Podfile << EOF
    require_relative '../node_modules/react-native/scripts/react_native_pods'
    require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'
    
    platform :ios, min_ios_version_supported
    prepare_react_native_project!
    
    target '$APP_NAME' do
      config = use_native_modules!
      use_react_native!(
        :path => config[:reactNativePath],
        :app_path => "#{Pod::Config.instance.installation_root}/.."
      )
    end
    
    post_install do |installer|
      react_native_post_install(installer)
    end
    EOF
    
    # Now run pod install with correct PATH
    cd ios
    export GEM_HOME=$HOME/.gem
    export PATH=$GEM_HOME/ruby/2.6.0/bin:$PATH
    pod install --repo-update
  displayName: 'Fix Podfile and Install Pods'

- script: |
    # React Native iOS ì•± ì´ë¦„ ìë™ ê°ì§€
    if [ -d "ios" ]; then
        APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
        if [ -z "$APP_NAME" ]; then
            echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ì—ì„œ Xcode í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
        fi
        echo "ê°ì§€ëœ ì•± ì´ë¦„: $APP_NAME"
    else
        echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
        exit 1
    fi
    
    # Info.plist ê²½ë¡œ
    INFO_PLIST_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}/Info.plist"
    echo "Info.plist í™•ì¸ ê²½ë¡œ: $INFO_PLIST_PATH"

    # 1. Info.plistì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
    if [ -f "$INFO_PLIST_PATH" ]; then
        echo "Info.plist ë°œê²¬. CFBundleIdentifier ì¶”ì¶œ ì¤‘..."
        BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST_PATH" 2>/dev/null)
        
        # ë³€ìˆ˜ ê°’ì´ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ ë¹ˆ ê°’ì¸ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ
        if [[ "$BUNDLE_ID" == *"$"* ]] || [ -z "$BUNDLE_ID" ]; then
            echo "ë³€ìˆ˜ ê°ì§€ ë˜ëŠ” ë¹ˆ ê°’. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ PRODUCT_BUNDLE_IDENTIFIER ê²€ìƒ‰..."
            
            # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
            if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
                echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
                BUNDLE_ID=$(xcodebuild -showBuildSettings \
                            -workspace "ios/${APP_NAME}.xcworkspace" \
                            -scheme "${APP_NAME}" \
                            -configuration Release \
                            -sdk iphoneos 2>/dev/null |
                            grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                            awk -F '=' '{print $2}' |
                            sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            else
                echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
                BUNDLE_ID=$(xcodebuild -showBuildSettings \
                            -project "ios/${APP_NAME}.xcodeproj" \
                            -scheme "${APP_NAME}" \
                            -configuration Release \
                            -sdk iphoneos 2>/dev/null |
                            grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                            awk -F '=' '{print $2}' |
                            sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            fi
        fi
    else
        # 2. Info.plist ì—†ì„ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì§ì ‘ ì¶”ì¶œ
        echo "Info.plist ì—†ìŒ. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ..."
        
        # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
        if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
            echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
            BUNDLE_ID=$(xcodebuild -showBuildSettings \
                        -workspace "ios/${APP_NAME}.xcworkspace" \
                        -scheme "${APP_NAME}" \
                        -configuration Release \
                        -sdk iphoneos 2>/dev/null |
                        grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                        awk -F '=' '{print $2}' |
                        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        else
            echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
            BUNDLE_ID=$(xcodebuild -showBuildSettings \
                        -project "ios/${APP_NAME}.xcodeproj" \
                        -scheme "${APP_NAME}" \
                        -configuration Release \
                        -sdk iphoneos 2>/dev/null |
                        grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                        awk -F '=' '{print $2}' |
                        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        fi
    fi

    # 3. ì—¬ì „íˆ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° pbxproj íŒŒì¼ì—ì„œ ì§ì ‘ ê²€ìƒ‰
    if [ -z "$BUNDLE_ID" ]; then
        echo "ë¹Œë“œ ì„¤ì •ì—ì„œ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. pbxproj íŒŒì¼ì—ì„œ ê²€ìƒ‰..."
        PBXPROJ_PATH="ios/${APP_NAME}.xcodeproj/project.pbxproj"
        if [ -f "$PBXPROJ_PATH" ]; then
            BUNDLE_ID=$(grep -A 5 "PRODUCT_BUNDLE_IDENTIFIER" "$PBXPROJ_PATH" | 
                       grep -o '"[^"]*"' | 
                       head -1 | 
                       sed 's/"//g')
        fi
    fi

    # ìµœì¢… ê²€ì¦
    if [ -z "$BUNDLE_ID" ]; then
        echo "##vso[task.logissue type=error] ë²ˆë“¤ ì‹ë³„ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        exit 1
    fi

    echo "ì¶”ì¶œëœ BUNDLE_ID: $BUNDLE_ID"
    echo "##vso[task.setvariable variable=BUNDLE_ID]$BUNDLE_ID"
    echo "##vso[task.logissue type=warning] ì¶”ì¶œëœ Bundle ID: $BUNDLE_ID"
  displayName: 'Extract Bundle ID from React Native iOS Project'

- script: |
    EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
    mkdir -p "$EXPORT_DIR"
    
    cat << EOF > "$EXPORT_DIR/ExportOptions.plist"
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>method</key>
        <string>app-store</string>
        <key>teamID</key>
        <string>${{ parameters.TEAM_ID }}</string>
        <key>provisioningProfiles</key>
        <dict>
            <key>$BUNDLE_ID</key>
            <string>${{ parameters.PROVISIONING_PROFILE_NAME }}</string>
        </dict>
    </dict>
    </plist>
    EOF
    
    echo "ExportOptions.plist created with provisioningProfiles and bundle ID."
    cat "$EXPORT_DIR/ExportOptions.plist"  # Output the created plist content for debugging

  displayName: 'Generate ExportOptions.plist'

- script: |
    echo "Creating Bridging Header..."
    cat > ios/Azure_RN078-Bridging-Header.h << 'EOF'
    #import <React/RCTBridgeModule.h>
    #import <React/RCTBridge.h>
    #import <React/RCTEventDispatcher.h>
    #import <React/RCTRootView.h>
    #import <React/RCTUtils.h>
    #import <React/RCTConvert.h>
    #import <React/RCTBundleURLProvider.h>
    EOF
    
    echo "Updating project file with sed instead of plutil..."
    cd ios
    sed -i '' 's|SWIFT_OBJC_BRIDGING_HEADER = .*;|SWIFT_OBJC_BRIDGING_HEADER = "Azure_RN078-Bridging-Header.h";|g' Azure_RN078.xcodeproj/project.pbxproj || echo "Sed command failed, will use direct reference in build command instead"
    cd ..
  displayName: 'Setup Bridging Header with sed'

- script: |
    # AppSealingSDKì˜ Hermes íŒŒì¼ì„ Pods ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
    echo "Hermes íŒŒì¼ êµì²´ ì‘ì—… ì‹œì‘..."

    # ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì„¤ì •
    APP_SEALING_SDK_DIR="$(Build.SourcesDirectory)/ios/AppSealingSDK"
    HERMES_SOURCE_FILES=$(find "$APP_SEALING_SDK_DIR" -name "*hermes*" -type f 2>/dev/null)

    # ëŒ€ìƒ ë””ë ‰í† ë¦¬ êµ¬ì¡°
    HERMES_DEST_DIR="$(Build.SourcesDirectory)/ios/Pods/hermes-engine/destroot/Library/Frameworks/universal/hermes.xcframework"

    # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
    if [ ! -d "$HERMES_DEST_DIR" ]; then
      echo "âŒ ëŒ€ìƒ ë””ë ‰í† ë¦¬ ì—†ìŒ: $HERMES_DEST_DIR"
      exit 1
    fi

    # tvOS, xros, x86_64 ì œì™¸í•˜ê³  Hermes íŒŒì¼ ê²€ìƒ‰
    EXISTING_HERMES_FILES=$(find "$HERMES_DEST_DIR" -type f -name "*hermes*" \
      ! -path "*tvos*" \
      ! -path "*xros*" \
      ! -path "*x86_64*" 2>/dev/null)

    if [ -n "$EXISTING_HERMES_FILES" ]; then
      echo "ğŸ” ë°œê²¬ëœ Hermes íŒŒì¼:"
      for TARGET_FILE in $EXISTING_HERMES_FILES; do
        FILENAME=$(basename "$TARGET_FILE")
        SOURCE_FILE=$(find "$APP_SEALING_SDK_DIR" -name "$FILENAME" -type f 2>/dev/null)
        
        if [ -n "$SOURCE_FILE" ]; then
          echo "ğŸ”„ êµì²´ ì¤‘: $TARGET_FILE"
          cp -f "$SOURCE_FILE" "$TARGET_FILE" || echo "âš ï¸  íŒŒì¼ êµì²´ ì‹¤íŒ¨: $FILENAME"
        else
          echo "â© ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ: $FILENAME"
        fi
      done
      echo "âœ… Hermes íŒŒì¼ êµì²´ ì™„ë£Œ!"
    else
      echo "âš ï¸  ëŒ€ìƒ ë””ë ‰í† ë¦¬ì— Hermes íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ"
    fi
  displayName: 'Copy Hermes Files from AppSealingSDK'
  
- script: |
    EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
    ARCHIVE_PATH="$EXPORT_DIR/${APP_NAME}.xcarchive"
    
    # 1. .xcworkspace ì¡´ì¬ í™•ì¸
    WORKSPACE_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}.xcworkspace"
    if [ ! -d "$WORKSPACE_PATH" ]; then
        echo "##vso[task.logissue type=error] .xcworkspace not found: $WORKSPACE_PATH"
        exit 1
    fi

    # ì €ì¥ëœ Hermes ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    APP_SEALING_SDK_DIR="$(Build.SourcesDirectory)/ios/AppSealingSDK"
    HERMES_DEST_DIR="$(Build.SourcesDirectory)/ios/Pods/hermes-engine/destroot/Library/Frameworks/universal/hermes.xcframework"

    # tvOS, xros, x86-64 ì œì™¸í•˜ê³  Hermes íŒŒì¼ ê²€ìƒ‰
    EXISTING_HERMES_FILES=$(find "$HERMES_DEST_DIR" -type f -name "*hermes*" ! -path "*tvos*" ! -path "*xros*" ! -path "*x86-64*" 2>/dev/null)

    if [ -z "$EXISTING_HERMES_FILES" ]; then
      echo "âŒ Hermes íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²€ì¦ ì‹¤íŒ¨!"
      exit 1
    fi

    VERIFICATION_FAILED=0

    for TARGET_FILE in $EXISTING_HERMES_FILES; do
      FILENAME=$(basename "$TARGET_FILE")
      SOURCE_FILE=$(find "$APP_SEALING_SDK_DIR" -name "$FILENAME" -type f 2>/dev/null)

      if [[ -z "$SOURCE_FILE" ]]; then
        echo "âŒ ì†ŒìŠ¤ íŒŒì¼ ëˆ„ë½: $FILENAME"
        VERIFICATION_FAILED=1
        continue
      fi

      # ê²€ì¦: íŒŒì¼ ë‚´ìš© ë¹„êµ ë° í¬ê¸° ì¶œë ¥
      TARGET_SIZE=$(stat -f%z "$TARGET_FILE")
      SOURCE_SIZE=$(stat -f%z "$SOURCE_FILE")

      if cmp -s "$SOURCE_FILE" "$TARGET_FILE"; then
        echo "âœ… ê²€ì¦ ì„±ê³µ: $FILENAME"
        echo "  ì†ŒìŠ¤ íŒŒì¼ í¬ê¸°: ${SOURCE_SIZE} ë°”ì´íŠ¸"
        echo "  ëŒ€ìƒ íŒŒì¼ í¬ê¸°: ${TARGET_SIZE} ë°”ì´íŠ¸"
      else
        echo "âŒ ê²€ì¦ ì‹¤íŒ¨: $FILENAME (íŒŒì¼ ë‚´ìš© ë¶ˆì¼ì¹˜)"
        echo "  ì†ŒìŠ¤ íŒŒì¼ í¬ê¸°: ${SOURCE_SIZE} ë°”ì´íŠ¸"
        echo "  ëŒ€ìƒ íŒŒì¼ í¬ê¸°: ${TARGET_SIZE} ë°”ì´íŠ¸"
        VERIFICATION_FAILED=1
      fi
    done

    if [ $VERIFICATION_FAILED -ne 0 ]; then
      echo "âŒ Hermes íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨. ë¹Œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
      exit 1
    else
      echo "âœ… ëª¨ë“  Hermes íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤."
    fi

    # 2. ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
    cd ios
    xcodebuild clean archive \
          -workspace "${APP_NAME}.xcworkspace" \
          -scheme "${APP_NAME}" \
          -sdk iphoneos \
          -configuration Release \
          clean archive \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          CODE_SIGN_STYLE="Manual" \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          DEVELOPMENT_TEAM="${{ parameters.TEAM_ID }}" \
          PROVISIONING_PROFILE_SPECIFIER="${{ parameters.PROVISIONING_PROFILE_NAME }}" \
          SWIFT_OBJC_BRIDGING_HEADER="Azure_RN078-Bridging-Header.h" \
          -archivePath "$(Build.ArtifactStagingDirectory)/${APP_NAME}.xcarchive"

    # 3. IPA ë‚´ë³´ë‚´ê¸°
    xcodebuild -exportArchive \
      -archivePath "$ARCHIVE_PATH" \
      -exportOptionsPlist "$EXPORT_DIR/ExportOptions.plist" \
      -exportPath "$EXPORT_DIR"
    
    echo "IPA exported to: $EXPORT_DIR"
  displayName: 'Build and Export IPA'

- script: |
    # Grant execution permission to generate_hash script
    HASH_SCRIPT_PATH="$(Build.SourcesDirectory)/ios/AppSealingSDK/generate_hash"
    echo "-------------------------------------"
    cd "$(Build.SourcesDirectory)/ios/AppSealingSDK"
    ls -al
    echo "-------------------------------------"
    EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
    cd "$EXPORT_DIR"
    ls -al
    echo "-------------------------------------"
    IPA_PATH=$(find "$EXPORT_DIR" -type f -name "*.ipa" | head -n 1)

    echo "Granting execution permission to generate_hash..."
    chmod +x "$HASH_SCRIPT_PATH"

    echo "Running generate_hash with IPA... $IPA_PATH"
    "$HASH_SCRIPT_PATH" "$IPA_PATH"
  displayName: 'Run generate_hash on IPA'

- script: |
    # Upload the IPA file to TestFlight using altool
    IPA_PATH=$(find "$(Build.ArtifactStagingDirectory)" -type f -name "*.ipa" | head -n 1)

    if [ -f "$IPA_PATH" ]; then
        xcrun altool --upload-app \
          -f "$IPA_PATH" \
          -t ios \
          -u "${{ parameters.APPLE_ID }}" \
          -p "${{ parameters.APP_SPECIFIC_PASSWORD }}"

        echo "Uploaded IPA to TestFlight successfully."
    else
        echo "IPA file not found. Skipping upload."
        exit 1
    fi
  displayName: 'Upload to TestFlight'

- script: |
    # Cleanup temporary keychain and build artifacts
    TEMP_KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"

    if [ -f "$TEMP_KEYCHAIN_PATH" ]; then
        security delete-keychain "$TEMP_KEYCHAIN_PATH"
        echo "Temporary keychain deleted successfully."
    else
        echo "Temporary keychain not found. Skipping deletion."
    fi

    rm -rf "$(Build.ArtifactStagingDirectory)" ios/build ios/Pods ios/Podfile.lock

    echo "Cleanup completed."
  displayName: 'Cleanup Temporary Files'
