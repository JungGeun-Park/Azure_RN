trigger:
- main

pool:
  name: APPSEALING

parameters:
- name: APPLE_ID
  type: string
  default: 'puzznic@inka.co.kr'
- name: APP_SPECIFIC_PASSWORD
  type: string
  default: 'qbrz-hmfz-robj-eohm'
- name: TEAM_ID
  type: string
  default: '22X77ENQ2H'
- name: PROVISIONING_PROFILE_NAME
  type: string
  default: 'AppSealing Wildcard Distribution Profile'

steps:
- script: |
    # Automatically detect the app name from the iOS directory
    IOS_PATH="ios"
    if [ -d "$IOS_PATH" ]; then
        APP_NAME=$(ls "$IOS_PATH" | grep ".xcodeproj" | sed 's/.xcodeproj//')
        if [ -z "$APP_NAME" ]; then
            echo "No Xcode project found in the iOS directory."
            exit 1
        fi
    else
        echo "iOS directory not found."
        exit 1
    fi

    echo "Detected app name: $APP_NAME"
    echo "##vso[task.setvariable variable=APP_NAME]$APP_NAME"
  displayName: 'Detect App Name'

- script: |
    # Define paths for provisioning profile and keychain setup
    P12_CERT_PATH="$(Build.SourcesDirectory)/ios/distribution.p12"
    PROVISIONING_PROFILE_PATH="$(Build.SourcesDirectory)/ios/profile.mobileprovision"
    KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"
    KEYCHAIN_PASSWORD="temp123"

    # Create a temporary keychain for code signing
    if security list-keychains | grep -q "temp-keychain.keychain-db"; then
        echo "Deleting existing temporary keychain..."
        security delete-keychain "$KEYCHAIN_PATH"
    fi

    echo "Creating temporary keychain..."
    security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

    echo "Setting temporary keychain as default..."
    security list-keychains -d user -s "$KEYCHAIN_PATH"
    security default-keychain -s "$KEYCHAIN_PATH"
    security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
    security set-keychain-settings -lut 3600 "$KEYCHAIN_PATH"

    echo "Importing distribution certificate (PKCS#12) into temporary keychain..."
    security import "$P12_CERT_PATH" -k "$KEYCHAIN_PATH" -P "123456" -T /usr/bin/codesign
    security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
  displayName: 'Setup Temporary Keychain and Install Certificate'

- task: NodeTool@0
  inputs:
    versionSpec: '18.x'  # React NativeÏôÄ Ìò∏ÌôòÎêòÎäî ÏïàÏ†ïÏ†ÅÏù∏ Î≤ÑÏ†Ñ ÏÇ¨Ïö©
  displayName: 'Install Node.js'

- script: |
    echo "Removing existing node_modules..."
    rm -rf node_modules
    rm -f package-lock.json

    echo "Reinstalling Node modules..."
    npm install --legacy-peer-deps

    echo "Verifying React Native scripts..."
    if [ -f "node_modules/react-native/scripts/react_native_pods.rb" ]; then
      echo "‚úÖ React Native scripts found!"
    else
      echo "‚ùå React Native scripts missing! Attempting to restore..."
      npm audit fix --force
    fi
  displayName: 'Reinstall Node Modules'

- script: |
    echo "üîß Hermes podspec ÏïàÏ†ÑÌïòÍ≤å ÏàòÏ†ï Ï§ë (macOS ÎπÑÌò∏Ìôò Î∏îÎ°ù ÎπÑÌôúÏÑ±Ìôî)"

    PODSPEC_PATH="node_modules/react-native/sdks/hermes-engine/hermes-engine.podspec"
    BACKUP_PATH="$PODSPEC_PATH.bak"

    cp "$PODSPEC_PATH" "$BACKUP_PATH"

    ruby -e "
      path = '$PODSPEC_PATH'
      content = File.read(path)

      # Îã§Ïö¥Î°úÎìú ÌÉÄÎ•¥Î≥º Î∏îÎ°ù ÎπÑÌôúÏÑ±Ìôî
      content.gsub!(
        /^(\s*)if source_type == HermesEngineSourceType::DOWNLOAD_PREBUILD_RELEASE_TARBALL.*?^(\s*)end\s*$/m
      ) do |block|
        indent = $1 || ''
        disabled = block.lines.map { |l| indent + '# ' + l.strip }.join("\n")
        \"#{indent}if false # Disabled by CI patch\\n#{disabled}\\n#{indent}end\"
      end

      File.write(path, content)
      puts '‚úÖ hermes-engine.podspec ÏàòÏ†ï ÏôÑÎ£å'
    "

    echo "üß™ podspec Ruby Î¨∏Î≤ï Í≤ÄÏÇ¨"
    ruby -c "$PODSPEC_PATH"
  displayName: '[Hermes] Podspec ÏïàÏ†Ñ ÏàòÏ†ï'

- script: |
    export GEM_HOME=$HOME/.gem
    export PATH=$GEM_HOME/bin:$PATH
    
    echo "Installing CocoaPods..."
    gem install cocoapods --user-install
    
    echo "CocoaPods version:"
    export PATH=$HOME/.gem/ruby/*/bin:$PATH
    which pod || echo "Pod not found in PATH"
    pod --version || echo "Pod command not available"
  displayName: 'Install CocoaPods'

- script: |
    # First, detect the app name correctly
    APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
    echo "Detected app name: $APP_NAME"
    
    # # Create Podfile with proper variable substitution
    # cat > ios/Podfile << EOF
    # require_relative '../node_modules/react-native/scripts/react_native_pods'
    # require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'
    
    # platform :ios, min_ios_version_supported
    # prepare_react_native_project!
    
    # target '$APP_NAME' do
    #   config = use_native_modules!
    #   use_react_native!(
    #     :path => config[:reactNativePath],
    #     :app_path => "#{Pod::Config.instance.installation_root}/.."
    #   )
    # end
    
    # post_install do |installer|
    #   react_native_post_install(installer)
    # end
    # EOF
    
    # Now run pod install with correct PATH
    cd ios
    export GEM_HOME=$HOME/.gem
    export PATH=$GEM_HOME/ruby/2.6.0/bin:$PATH
    pod install --repo-update
  displayName: 'Fix Podfile and Install Pods'

- script: |
    # React Native iOS Ïï± Ïù¥Î¶Ñ ÏûêÎèô Í∞êÏßÄ
    if [ -d "ios" ]; then
        APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
        if [ -z "$APP_NAME" ]; then
            echo "##vso[task.logissue type=error] iOS ÎîîÎ†âÌÜ†Î¶¨ÏóêÏÑú Xcode ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            exit 1
        fi
        echo "Í∞êÏßÄÎêú Ïï± Ïù¥Î¶Ñ: $APP_NAME"
    else
        echo "##vso[task.logissue type=error] iOS ÎîîÎ†âÌÜ†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. React Native ÌîÑÎ°úÏ†ùÌä∏Ïù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî."
        exit 1
    fi
    
    # Info.plist Í≤ΩÎ°ú
    INFO_PLIST_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}/Info.plist"
    echo "Info.plist ÌôïÏù∏ Í≤ΩÎ°ú: $INFO_PLIST_PATH"

    # 1. Info.plistÏóêÏÑú ÏßÅÏ†ë Ï∂îÏ∂ú ÏãúÎèÑ
    if [ -f "$INFO_PLIST_PATH" ]; then
        echo "Info.plist Î∞úÍ≤¨. CFBundleIdentifier Ï∂îÏ∂ú Ï§ë..."
        BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST_PATH" 2>/dev/null)
        
        # Î≥ÄÏàò Í∞íÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÍ±∞ÎÇò Îπà Í∞íÏù∏ Í≤ΩÏö∞ Xcode ÎπåÎìú ÏÑ§Ï†ïÏóêÏÑú Ï∂îÏ∂ú
        if [[ "$BUNDLE_ID" == *"$"* ]] || [ -z "$BUNDLE_ID" ]; then
            echo "Î≥ÄÏàò Í∞êÏßÄ ÎòêÎäî Îπà Í∞í. Xcode ÎπåÎìú ÏÑ§Ï†ïÏóêÏÑú PRODUCT_BUNDLE_IDENTIFIER Í≤ÄÏÉâ..."
            
            # ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌååÏùº ÌôïÏù∏
            if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
                echo "ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌååÏùº ÏÇ¨Ïö©: ios/${APP_NAME}.xcworkspace"
                BUNDLE_ID=$(xcodebuild -showBuildSettings \
                            -workspace "ios/${APP_NAME}.xcworkspace" \
                            -scheme "${APP_NAME}" \
                            -configuration Release \
                            -sdk iphoneos 2>/dev/null |
                            grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                            awk -F '=' '{print $2}' |
                            sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            else
                echo "ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùº ÏÇ¨Ïö©: ios/${APP_NAME}.xcodeproj"
                BUNDLE_ID=$(xcodebuild -showBuildSettings \
                            -project "ios/${APP_NAME}.xcodeproj" \
                            -scheme "${APP_NAME}" \
                            -configuration Release \
                            -sdk iphoneos 2>/dev/null |
                            grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                            awk -F '=' '{print $2}' |
                            sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
            fi
        fi
    else
        # 2. Info.plist ÏóÜÏùÑ Í≤ΩÏö∞ Xcode ÎπåÎìú ÏÑ§Ï†ïÏóêÏÑú ÏßÅÏ†ë Ï∂îÏ∂ú
        echo "Info.plist ÏóÜÏùå. Xcode ÎπåÎìú ÏÑ§Ï†ïÏóêÏÑú Ï∂îÏ∂ú..."
        
        # ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌååÏùº ÌôïÏù∏
        if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
            echo "ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌååÏùº ÏÇ¨Ïö©: ios/${APP_NAME}.xcworkspace"
            BUNDLE_ID=$(xcodebuild -showBuildSettings \
                        -workspace "ios/${APP_NAME}.xcworkspace" \
                        -scheme "${APP_NAME}" \
                        -configuration Release \
                        -sdk iphoneos 2>/dev/null |
                        grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                        awk -F '=' '{print $2}' |
                        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        else
            echo "ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùº ÏÇ¨Ïö©: ios/${APP_NAME}.xcodeproj"
            BUNDLE_ID=$(xcodebuild -showBuildSettings \
                        -project "ios/${APP_NAME}.xcodeproj" \
                        -scheme "${APP_NAME}" \
                        -configuration Release \
                        -sdk iphoneos 2>/dev/null |
                        grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                        awk -F '=' '{print $2}' |
                        sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        fi
    fi

    # 3. Ïó¨Ï†ÑÌûà Î≤àÎì§ IDÎ•º Ï∞æÏßÄ Î™ªÌïú Í≤ΩÏö∞ pbxproj ÌååÏùºÏóêÏÑú ÏßÅÏ†ë Í≤ÄÏÉâ
    if [ -z "$BUNDLE_ID" ]; then
        echo "ÎπåÎìú ÏÑ§Ï†ïÏóêÏÑú Î≤àÎì§ IDÎ•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§. pbxproj ÌååÏùºÏóêÏÑú Í≤ÄÏÉâ..."
        PBXPROJ_PATH="ios/${APP_NAME}.xcodeproj/project.pbxproj"
        if [ -f "$PBXPROJ_PATH" ]; then
            BUNDLE_ID=$(grep -A 5 "PRODUCT_BUNDLE_IDENTIFIER" "$PBXPROJ_PATH" | 
                       grep -o '"[^"]*"' | 
                       head -1 | 
                       sed 's/"//g')
        fi
    fi

    # ÏµúÏ¢Ö Í≤ÄÏ¶ù
    if [ -z "$BUNDLE_ID" ]; then
        echo "##vso[task.logissue type=error] Î≤àÎì§ ÏãùÎ≥ÑÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!"
        exit 1
    fi

    echo "Ï∂îÏ∂úÎêú BUNDLE_ID: $BUNDLE_ID"
    echo "##vso[task.setvariable variable=BUNDLE_ID]$BUNDLE_ID"
    echo "##vso[task.logissue type=warning] Ï∂îÏ∂úÎêú Bundle ID: $BUNDLE_ID"
  displayName: 'Extract Bundle ID from React Native iOS Project'

- script: |
    echo "üîç Searching and replacing ARM64 'hermes' files in pods/hermes-engine..."

    # Define paths
    HERMES_ENGINE_PATH="ios/Pods/hermes-engine"
    APP_SEALING_SDK_PATH="ios/AppSealingSDK"

    # Function to find ARM64 'hermes' files
    find_arm64_hermes_files() {
        # 1. ios-arm64 ÎîîÎ†âÌÜ†Î¶¨ÏóêÏÑú ÌååÏùº Í≤ÄÏÉâ
        find "$1" -type f -path "*ios-arm64*" -name "hermes" 2>/dev/null
        
        # 2. lipo ÏïÑÌÇ§ÌÖçÏ≤ò Í≤ÄÏÇ¨ (Ï∂îÍ∞Ä Í≤ÄÏ¶ùÏö©)
        # find "$1" -type f -name "hermes" -exec sh -c '
        #     lipo -archs "$1" | grep -q "arm64" && echo "$1"
        # ' sh {} \; 2>/dev/null
    }

    # Step 1: Search for ARM64 hermes files
    if [ -d "$HERMES_ENGINE_PATH" ]; then
        echo "‚úÖ Directory found: $HERMES_ENGINE_PATH"
        HERMES_FILES=$(find_arm64_hermes_files "$HERMES_ENGINE_PATH")

        if [ -z "$HERMES_FILES" ]; then
            echo "‚ùå No ARM64 'hermes' files found in $HERMES_ENGINE_PATH."
            exit 1
        else
            echo "üîç Found ARM64 'hermes' files:"
            for file in $HERMES_FILES; do
                FILE_SIZE=$(stat -f%z "$file")
                ARCHITECTURES=$(lipo -archs "$file" 2>/dev/null || echo "Unknown")
                echo "  Path: $file"
                echo "  Size: ${FILE_SIZE} bytes"
                echo "  Arch: ${ARCHITECTURES}"
            done
        fi
    else
        echo "‚ùå Directory not found: $HERMES_ENGINE_PATH"
        exit 1
    fi

    # Step 2: Find source ARM64 hermes file
    if [ -d "$APP_SEALING_SDK_PATH" ]; then
        echo "‚úÖ Directory found: $APP_SEALING_SDK_PATH"
        SOURCE_HERMES_FILE=$(find_arm64_hermes_files "$APP_SEALING_SDK_PATH" | head -n 1)

        if [ -z "$SOURCE_HERMES_FILE" ]; then
            echo "‚ùå No ARM64 'hermes' file found in $APP_SEALING_SDK_PATH."
            exit 1
        else
            SOURCE_SIZE=$(stat -f%z "$SOURCE_HERMES_FILE")
            SOURCE_ARCH=$(lipo -archs "$SOURCE_HERMES_FILE" 2>/dev/null || echo "Unknown")
            echo "Source ARM64 'hermes' file: $SOURCE_HERMES_FILE"
            echo "  Size: ${SOURCE_SIZE} bytes"
            echo "  Arch: ${SOURCE_ARCH}"
        fi
    else
        echo "‚ùå Directory not found: $APP_SEALING_SDK_PATH"
        exit 1
    fi

    # Step 3: Architecture validation
    if ! echo "$SOURCE_ARCH" | grep -q "arm64"; then
        echo "##vso[task.logissue type=error] AppSealingSDK HermesÍ∞Ä arm64 ÏïÑÌÇ§ÌÖçÏ≤òÎ•º Ìè¨Ìï®ÌïòÏßÄ ÏïäÏùå"
        exit 1
    fi

    # Step 4: Replace files
    for TARGET_FILE in $HERMES_FILES; do
        echo "üîÑ Replacing: $TARGET_FILE"
        cp -fv "$SOURCE_HERMES_FILE" "$TARGET_FILE"
        
        # Verify architecture after replacement
        UPDATED_ARCH=$(lipo -archs "$TARGET_FILE" 2>/dev/null || echo "Unknown")
        if ! echo "$UPDATED_ARCH" | grep -q "arm64"; then
            echo "##vso[task.logissue type=error] ÏïÑÌÇ§ÌÖçÏ≤ò Í≤ÄÏ¶ù Ïã§Ìå®: $TARGET_FILE"
            exit 1
        fi
    done

    # Final verification
    echo "üîç Final verification:"
    for file in $HERMES_FILES; do
        FILE_SIZE=$(stat -f%z "$file")
        ARCHITECTURES=$(lipo -archs "$file" 2>/dev/null || echo "Unknown")
        echo "  Path: $file"
        echo "  Size: ${FILE_SIZE} bytes"
        echo "  Arch: ${ARCHITECTURES}"
    done
  displayName: '[Ï§ëÏöî] Replace ARM64 Hermes Files in Pods'

- script: |
    EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
    mkdir -p "$EXPORT_DIR"
    
    cat << EOF > "$EXPORT_DIR/ExportOptions.plist"
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>method</key>
        <string>app-store</string>
        <key>teamID</key>
        <string>${{ parameters.TEAM_ID }}</string>
        <key>provisioningProfiles</key>
        <dict>
            <key>$BUNDLE_ID</key>
            <string>${{ parameters.PROVISIONING_PROFILE_NAME }}</string>
        </dict>
    </dict>
    </plist>
    EOF
    
    echo "ExportOptions.plist created with provisioningProfiles and bundle ID."
    cat "$EXPORT_DIR/ExportOptions.plist"  # Output the created plist content for debugging

  displayName: 'Generate ExportOptions.plist'

- script: |
    echo "Creating Bridging Header..."
    cat > ios/Azure_RN078-Bridging-Header.h << 'EOF'
    #import <React/RCTBridgeModule.h>
    #import <React/RCTBridge.h>
    #import <React/RCTEventDispatcher.h>
    #import <React/RCTRootView.h>
    #import <React/RCTUtils.h>
    #import <React/RCTConvert.h>
    #import <React/RCTBundleURLProvider.h>
    EOF
    
    echo "Updating project file with sed instead of plutil..."
    cd ios
    sed -i '' 's|SWIFT_OBJC_BRIDGING_HEADER = .*;|SWIFT_OBJC_BRIDGING_HEADER = "Azure_RN078-Bridging-Header.h";|g' Azure_RN078.xcodeproj/project.pbxproj || echo "Sed command failed, will use direct reference in build command instead"
    cd ..
  displayName: 'Setup Bridging Header with sed'

- script: |
    EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
    ARCHIVE_PATH="$EXPORT_DIR/${APP_NAME}.xcarchive"
    
    # 1. .xcworkspace Ï°¥Ïû¨ ÌôïÏù∏
    WORKSPACE_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}.xcworkspace"
    if [ ! -d "$WORKSPACE_PATH" ]; then
        echo "##vso[task.logissue type=error] .xcworkspace not found: $WORKSPACE_PATH"
        exit 1
    fi

    rm -rf ~/Library/Developer/Xcode/DerivedData
    rm -rf ios/Pods
    pod cache clean --all
  
    # 2. ÏïÑÏπ¥Ïù¥Î∏å ÎπåÎìú
    cd ios
    xcodebuild clean archive \
      -workspace "${APP_NAME}.xcworkspace" \
      -scheme "${APP_NAME}" \
      -sdk iphoneos \
      -configuration Release \
      clean archive \
      CODE_SIGN_IDENTITY="Apple Distribution" \
      CODE_SIGN_STYLE="Manual" \
      CODE_SIGN_IDENTITY="Apple Distribution" \
      DEVELOPMENT_TEAM="${{ parameters.TEAM_ID }}" \
      PROVISIONING_PROFILE_SPECIFIER="${{ parameters.PROVISIONING_PROFILE_NAME }}" \
      SWIFT_OBJC_BRIDGING_HEADER="Azure_RN078-Bridging-Header.h" \
      -archivePath "$(Build.ArtifactStagingDirectory)/${APP_NAME}.xcarchive"

    # 3. IPA ÎÇ¥Î≥¥ÎÇ¥Í∏∞
    xcodebuild -exportArchive \
      -archivePath "$ARCHIVE_PATH" \
      -exportOptionsPlist "$EXPORT_DIR/ExportOptions.plist" \
      -exportPath "$EXPORT_DIR"
    
    echo "IPA exported to: $EXPORT_DIR"
  displayName: 'Build and Export IPA'

# - script: |
#     echo "üîç IPA ÌååÏùº ÎÇ¥ Hermes ÌååÏùº ÍµêÏ≤¥ ÏûëÏóÖ ÏãúÏûë..."

#     # Í≤ΩÎ°ú ÏÑ§Ï†ï
#     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
#     IPA_PATH=$(find "$EXPORT_DIR" -type f -name "*.ipa" | head -n 1)
#     EXTRACT_DIR="$EXPORT_DIR/extracted_ipa"
#     REPACKED_IPA="$EXPORT_DIR/repacked_app.ipa"
#     APP_SEALING_SDK_DIR="$(Build.SourcesDirectory)/ios/AppSealingSDK"

#     # 1. IPA ÌååÏùº Ï∂îÏ∂ú
#     echo "üì¶ IPA Ï∂îÏ∂ú: $IPA_PATH -> $EXTRACT_DIR"
#     rm -rf "$EXTRACT_DIR"
#     unzip -q "$IPA_PATH" -d "$EXTRACT_DIR"

#     # ÎîîÎ≤ÑÍπÖ: ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ Ï∂úÎ†•
#     echo "üîé Ï∂îÏ∂úÎêú ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞:"
#     find "$EXTRACT_DIR" -type d | sed 's/^/  /'

#     # 2. Hermes ÌååÏùº Í≤ÄÏÉâ (Ï†ïÌôïÌïú Ïù¥Î¶ÑÍ≥º ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ)
#     echo "üîç Hermes ÌååÏùº Í≤ÄÏÉâ ÏãúÏûë..."
#     HERMES_FILES=$(find "$EXTRACT_DIR" -type f -name "hermes" 2>/dev/null)

#     # ÎîîÎ≤ÑÍπÖ: Î∞úÍ≤¨Îêú ÌååÏùº Î™©Î°ù Ï∂úÎ†•
#     echo "üîç Î∞úÍ≤¨Îêú Hermes ÌååÏùº Î™©Î°ù:"
#     echo "$HERMES_FILES" | sed 's/^/  /'

#     if [ -z "$HERMES_FILES" ]; then
#         echo "‚ùå Ï∂îÏ∂úÎêú IPAÏóêÏÑú Hermes ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
#         exit 1
#     fi

#     # 3. ÌååÏùº ÍµêÏ≤¥
#     for TARGET_FILE in $HERMES_FILES; do
#         FILENAME=$(basename "$TARGET_FILE")
#         SOURCE_FILE=$(find "$APP_SEALING_SDK_DIR" -name "$FILENAME" -type f 2>/dev/null)

#         if [ -n "$SOURCE_FILE" ]; then
#             echo "üîÑ ÍµêÏ≤¥: $TARGET_FILE"
#             cp -fv "$SOURCE_FILE" "$TARGET_FILE" || echo "‚ö†Ô∏è  Ïã§Ìå®: $FILENAME"
            
#             # Í≤ÄÏ¶ù: ÌååÏùº ÌÅ¨Í∏∞ ÎπÑÍµê
#             TARGET_SIZE=$(stat -f%z "$TARGET_FILE")
#             SOURCE_SIZE=$(stat -f%z "$SOURCE_FILE")
#             echo "  ÏÜåÏä§ ÌÅ¨Í∏∞: ${SOURCE_SIZE} Î∞îÏù¥Ìä∏"
#             echo "  ÎåÄÏÉÅ ÌÅ¨Í∏∞: ${TARGET_SIZE} Î∞îÏù¥Ìä∏"
#         else
#             echo "‚è© ÏÜåÏä§ ÌååÏùº ÏóÜÏùå: $FILENAME"
#         fi
#     done

#     # 4. Ïû¨ÏïïÏ∂ï
#     echo "üì¶ Ïû¨ÏïïÏ∂ï: $REPACKED_IPA"
#     cd "$EXTRACT_DIR"
#     zip -qr "$REPACKED_IPA" ./*
    
#     echo "‚úÖ Hermes ÌååÏùº ÍµêÏ≤¥ ÏôÑÎ£å!"
#   displayName: '[Ï§ëÏöî] IPA ÎÇ¥ Hermes ÌååÏùº ÍµêÏ≤¥ Î∞è Í≤ÄÏ¶ù'

# - script: |
#     # Grant execution permission to generate_hash script
#     HASH_SCRIPT_PATH="$(Build.SourcesDirectory)/ios/AppSealingSDK/generate_hash"
#     # echo "-------------------------------------"
#     # cd "$(Build.SourcesDirectory)/ios/AppSealingSDK"
#     # ls -al
#     # echo "-------------------------------------"
#     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
#     # cd "$EXPORT_DIR"
#     # ls -al
#     # echo "-------------------------------------"
#     IPA_PATH=$(find "$EXPORT_DIR" -type f -name "*.ipa" | head -n 1)

#     echo "Granting execution permission to generate_hash..."
#     chmod +x "$HASH_SCRIPT_PATH"

#     echo "Running generate_hash with IPA... $IPA_PATH"
#     "$HASH_SCRIPT_PATH" "$IPA_PATH"
#   displayName: 'Run generate_hash on IPA'

# - script: |
#     # Upload the IPA file to TestFlight using altool
#     IPA_PATH=$(find "$(Build.ArtifactStagingDirectory)" -type f -name "*.ipa" | head -n 1)

#     if [ -f "$IPA_PATH" ]; then
#         xcrun altool --upload-app \
#           -f "$IPA_PATH" \
#           -t ios \
#           -u "${{ parameters.APPLE_ID }}" \
#           -p "${{ parameters.APP_SPECIFIC_PASSWORD }}"

#         echo "Uploaded IPA to TestFlight successfully."
#     else
#         echo "IPA file not found. Skipping upload."
#         exit 1
#     fi
#   displayName: 'Upload to TestFlight'

# - script: |
#     # Cleanup temporary keychain and build artifacts
#     TEMP_KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"

#     if [ -f "$TEMP_KEYCHAIN_PATH" ]; then
#         security delete-keychain "$TEMP_KEYCHAIN_PATH"
#         echo "Temporary keychain deleted successfully."
#     else
#         echo "Temporary keychain not found. Skipping deletion."
#     fi

#     rm -rf "$(Build.ArtifactStagingDirectory)" ios/build ios/Pods ios/Podfile.lock

#     echo "Cleanup completed."
#   displayName: 'Cleanup Temporary Files'
