trigger:
- main

pool:
  name: APPSEALING

parameters:
- name: APPLE_ID
  type: string
  default: 'puzznic@inka.co.kr'
- name: APP_SPECIFIC_PASSWORD
  type: string
  default: 'qbrz-hmfz-robj-eohm'
- name: TEAM_ID
  type: string
  default: '22X77ENQ2H'
- name: PROVISIONING_PROFILE_NAME
  type: string
  default: 'AppSealing Wildcard Distribution Profile'

steps:
# - script: |
#     # Automatically detect the app name from the iOS directory
#     IOS_PATH="ios"
#     if [ -d "$IOS_PATH" ]; then
#         APP_NAME=$(ls "$IOS_PATH" | grep ".xcodeproj" | sed 's/.xcodeproj//')
#         if [ -z "$APP_NAME" ]; then
#             echo "No Xcode project found in the iOS directory."
#             exit 1
#         fi
#     else
#         echo "iOS directory not found."
#         exit 1
#     fi

#     echo "Detected app name: $APP_NAME"
#     echo "##vso[task.setvariable variable=APP_NAME]$APP_NAME"
#   displayName: 'Detect App Name'

# - script: |
#     # Define paths for provisioning profile and keychain setup
#     P12_CERT_PATH="$(Build.SourcesDirectory)/ios/distribution.p12"
#     PROVISIONING_PROFILE_PATH="$(Build.SourcesDirectory)/ios/profile.mobileprovision"
#     KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"
#     KEYCHAIN_PASSWORD="temp123"

#     # Create a temporary keychain for code signing
#     if security list-keychains | grep -q "temp-keychain.keychain-db"; then
#         echo "Deleting existing temporary keychain..."
#         security delete-keychain "$KEYCHAIN_PATH"
#     fi

#     echo "Creating temporary keychain..."
#     security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

#     echo "Setting temporary keychain as default..."
#     security list-keychains -d user -s "$KEYCHAIN_PATH"
#     security default-keychain -s "$KEYCHAIN_PATH"
#     security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
#     security set-keychain-settings -lut 3600 "$KEYCHAIN_PATH"

#     echo "Importing distribution certificate (PKCS#12) into temporary keychain..."
#     security import "$P12_CERT_PATH" -k "$KEYCHAIN_PATH" -P "123456" -T /usr/bin/codesign
#     security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
#   displayName: 'Setup Temporary Keychain and Install Certificate'

# - task: NodeTool@0
#   inputs:
#     versionSpec: '18.x'  # React Nativeì™€ í˜¸í™˜ë˜ëŠ” ì•ˆì •ì ì¸ ë²„ì „ ì‚¬ìš©
#   displayName: 'Install Node.js'

# - script: |
#     echo "Removing existing node_modules..."
#     rm -rf node_modules
#     rm -f package-lock.json

#     echo "Reinstalling Node modules..."
#     npm install --legacy-peer-deps

#     echo "Verifying React Native scripts..."
#     if [ -f "node_modules/react-native/scripts/react_native_pods.rb" ]; then
#       echo "âœ… React Native scripts found!"
#     else
#       echo "âŒ React Native scripts missing! Attempting to restore..."
#       npm audit fix --force
#     fi
#   displayName: 'Reinstall Node Modules'

# - script: |
#     # ê¸°ì¡´ Pods ì™„ì „ ì‚­ì œ
#     rm -rf ios/Pods
#     rm -rf ios/Podfile.lock
#     rm -rf ~/Library/Caches/CocoaPods

#     # CocoaPods ì¬ì„¤ì¹˜ (ì‹œìŠ¤í…œ Ruby ëŒ€ì‹  brew ì‚¬ìš©)
#     echo "Installing CocoaPods using Homebrew..."
#     brew install cocoapods

#     # Pod ì„¤ì¹˜ ì „ PATH ì„¤ì •
#     # export PATH="/opt/homebrew/bin:$PATH"
#     # which pod
#     # # Pod ì¬ì„¤ì¹˜
#     # cd ios
#     # pod install --repo-update --verbose
#     # cd ..
#   displayName: '[ìˆ˜ì •] Reinstall CocoaPods and Pods'
  
# - script: |
#     echo "ğŸ”§ Hermes podspec ì•ˆì „í•˜ê²Œ ìˆ˜ì • ì¤‘ (macOS ë¹„í˜¸í™˜ ë¸”ë¡ ë¹„í™œì„±í™”)"

#     PODSPEC_PATH="node_modules/react-native/sdks/hermes-engine/hermes-engine.podspec"
#     BACKUP_PATH="$PODSPEC_PATH.bak"

#     cp "$PODSPEC_PATH" "$BACKUP_PATH"

#     ruby -e "
#       path = '$PODSPEC_PATH'
#       content = File.read(path)

#       # ë‹¤ìš´ë¡œë“œ íƒ€ë¥´ë³¼ ë¸”ë¡ ë¹„í™œì„±í™”
#       content.gsub!(
#         /^(\s*)if source_type == HermesEngineSourceType::DOWNLOAD_PREBUILD_RELEASE_TARBALL.*?^(\s*)end\s*$/m
#       ) do |block|
#         match = block.match(/^(\s*)/)
#         indent = match ? match[1] : ''
#         disabled = block.lines.map { |l| indent + '# ' + l.strip }.join(\"\\n\")
#         \"#{indent}if false # Disabled by CI patch\\n#{disabled}\\n#{indent}end\"
#       end

#       File.write(path, content)
#       puts 'âœ… hermes-engine.podspec ìˆ˜ì • ì™„ë£Œ'
#     "

#     echo "ğŸ§ª podspec Ruby ë¬¸ë²• ê²€ì‚¬"
#     ruby -c "$PODSPEC_PATH"
#   displayName: '[Hermes] Podspec ì•ˆì „ ìˆ˜ì •'

# - script: |
#     # First, detect the app name correctly
#     # APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
#     # echo "Detected app name: $APP_NAME"
    
#     # Now run pod install with correct PATH
#     cd ios
#     export GEM_HOME=$HOME/.gem
#     export PATH=$GEM_HOME/ruby/2.6.0/bin:$PATH
#     pod install --repo-update
#   displayName: 'Fix Podfile and Install Pods'

# - script: |
#     # React Native iOS ì•± ì´ë¦„ ìë™ ê°ì§€
#     if [ -d "ios" ]; then
#         APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
#         if [ -z "$APP_NAME" ]; then
#             echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ì—ì„œ Xcode í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
#             exit 1
#         fi
#         echo "ê°ì§€ëœ ì•± ì´ë¦„: $APP_NAME"
#     else
#         echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
#         exit 1
#     fi
    
#     # Info.plist ê²½ë¡œ
#     INFO_PLIST_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}/Info.plist"
#     echo "Info.plist í™•ì¸ ê²½ë¡œ: $INFO_PLIST_PATH"

#     # 1. Info.plistì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
#     if [ -f "$INFO_PLIST_PATH" ]; then
#         echo "Info.plist ë°œê²¬. CFBundleIdentifier ì¶”ì¶œ ì¤‘..."
#         BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST_PATH" 2>/dev/null)
        
#         # ë³€ìˆ˜ ê°’ì´ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ ë¹ˆ ê°’ì¸ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ
#         if [[ "$BUNDLE_ID" == *"$"* ]] || [ -z "$BUNDLE_ID" ]; then
#             echo "ë³€ìˆ˜ ê°ì§€ ë˜ëŠ” ë¹ˆ ê°’. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ PRODUCT_BUNDLE_IDENTIFIER ê²€ìƒ‰..."
            
#             # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
#             if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
#                 echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
#                 BUNDLE_ID=$(xcodebuild -showBuildSettings \
#                             -workspace "ios/${APP_NAME}.xcworkspace" \
#                             -scheme "${APP_NAME}" \
#                             -configuration Release \
#                             -sdk iphoneos 2>/dev/null |
#                             grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
#                             awk -F '=' '{print $2}' |
#                             sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
#             else
#                 echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
#                 BUNDLE_ID=$(xcodebuild -showBuildSettings \
#                             -project "ios/${APP_NAME}.xcodeproj" \
#                             -scheme "${APP_NAME}" \
#                             -configuration Release \
#                             -sdk iphoneos 2>/dev/null |
#                             grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
#                             awk -F '=' '{print $2}' |
#                             sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
#             fi
#         fi
#     else
#         # 2. Info.plist ì—†ì„ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì§ì ‘ ì¶”ì¶œ
#         echo "Info.plist ì—†ìŒ. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ..."
        
#         # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
#         if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
#             echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
#             BUNDLE_ID=$(xcodebuild -showBuildSettings \
#                         -workspace "ios/${APP_NAME}.xcworkspace" \
#                         -scheme "${APP_NAME}" \
#                         -configuration Release \
#                         -sdk iphoneos 2>/dev/null |
#                         grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
#                         awk -F '=' '{print $2}' |
#                         sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
#         else
#             echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
#             BUNDLE_ID=$(xcodebuild -showBuildSettings \
#                         -project "ios/${APP_NAME}.xcodeproj" \
#                         -scheme "${APP_NAME}" \
#                         -configuration Release \
#                         -sdk iphoneos 2>/dev/null |
#                         grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
#                         awk -F '=' '{print $2}' |
#                         sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
#         fi
#     fi

#     # 3. ì—¬ì „íˆ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° pbxproj íŒŒì¼ì—ì„œ ì§ì ‘ ê²€ìƒ‰
#     if [ -z "$BUNDLE_ID" ]; then
#         echo "ë¹Œë“œ ì„¤ì •ì—ì„œ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. pbxproj íŒŒì¼ì—ì„œ ê²€ìƒ‰..."
#         PBXPROJ_PATH="ios/${APP_NAME}.xcodeproj/project.pbxproj"
#         if [ -f "$PBXPROJ_PATH" ]; then
#             BUNDLE_ID=$(grep -A 5 "PRODUCT_BUNDLE_IDENTIFIER" "$PBXPROJ_PATH" | 
#                        grep -o '"[^"]*"' | 
#                        head -1 | 
#                        sed 's/"//g')
#         fi
#     fi

#     # ìµœì¢… ê²€ì¦
#     if [ -z "$BUNDLE_ID" ]; then
#         echo "##vso[task.logissue type=error] ë²ˆë“¤ ì‹ë³„ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
#         exit 1
#     fi

#     echo "ì¶”ì¶œëœ BUNDLE_ID: $BUNDLE_ID"
#     echo "##vso[task.setvariable variable=BUNDLE_ID]$BUNDLE_ID"
#     echo "##vso[task.logissue type=warning] ì¶”ì¶œëœ Bundle ID: $BUNDLE_ID"
#   displayName: 'Extract Bundle ID from React Native iOS Project'

# - script: |
#     echo "ğŸ” ARM64 'hermes' íŒŒì¼ êµì²´ ì‘ì—… ì‹œì‘..."

#     # ê²½ë¡œ ì •ì˜
#     HERMES_ENGINE_PATH="ios/Pods/hermes-engine"
#     APP_SEALING_SDK_PATH="ios/AppSealingSDK"
#     SOURCE_HERMES_FILE="$APP_SEALING_SDK_PATH/hermes"

#     # Step 1: íƒ€ê²Ÿ í´ë” í™•ì¸
#     if [ ! -d "$HERMES_ENGINE_PATH" ]; then
#         echo "âŒ hermes-engine ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $HERMES_ENGINE_PATH"
#         exit 1
#     fi
#     echo "âœ… íƒ€ê²Ÿ í´ë” í™•ì¸ ì™„ë£Œ: $HERMES_ENGINE_PATH"

#     # Step 2: ì†ŒìŠ¤ íŒŒì¼ í™•ì¸
#     if [ ! -f "$SOURCE_HERMES_FILE" ]; then
#         echo "âŒ AppSealingSDK ì•ˆì— 'hermes' ë°”ì´ë„ˆë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: $SOURCE_HERMES_FILE"
#         exit 1
#     fi

#     SOURCE_SIZE=$(stat -f%z "$SOURCE_HERMES_FILE")
#     SOURCE_ARCH=$(lipo -archs "$SOURCE_HERMES_FILE" 2>/dev/null || echo "Unknown")
#     echo "âœ… AppSealingSDK hermes íŒŒì¼ í™•ì¸ë¨"
#     echo "  Path: $SOURCE_HERMES_FILE"
#     echo "  Size: ${SOURCE_SIZE} bytes"
#     echo "  Arch: ${SOURCE_ARCH}"

#     # Step 3: arm64 ì•„í‚¤í…ì²˜ ê²€ì¦
#     if ! echo "$SOURCE_ARCH" | grep -q "arm64"; then
#         echo "##vso[task.logissue type=error] AppSealingSDK Hermesê°€ arm64 ì•„í‚¤í…ì²˜ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŒ"
#         exit 1
#     fi

#     # Step 4: Pods ë‚´ë¶€ 'hermes' ë°”ì´ë„ˆë¦¬ ì°¾ê¸°
#     echo "ğŸ” hermes-engine ë‚´ë¶€ì˜ 'hermes' ë°”ì´ë„ˆë¦¬ ê²€ìƒ‰ ì¤‘..."
#     TARGET_HERMES_FILES=$(find "$HERMES_ENGINE_PATH" -type f -name "hermes" 2>/dev/null)

#     if [ -z "$TARGET_HERMES_FILES" ]; then
#         echo "âŒ hermes-engine ì•ˆì—ì„œ ëŒ€ì²´í•  'hermes' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
#         exit 1
#     fi

#     # Step 5: ë³µì‚¬ ë° ê²€ì¦
#     for TARGET_FILE in $TARGET_HERMES_FILES; do
#         echo "ğŸ”„ êµì²´ ì¤‘: $TARGET_FILE"
#         cp -fv "$SOURCE_HERMES_FILE" "$TARGET_FILE"

#         UPDATED_ARCH=$(lipo -archs "$TARGET_FILE" 2>/dev/null || echo "Unknown")
#         if ! echo "$UPDATED_ARCH" | grep -q "arm64"; then
#             echo "##vso[task.logissue type=error] ì•„í‚¤í…ì²˜ ê²€ì¦ ì‹¤íŒ¨: $TARGET_FILE"
#             exit 1
#         fi
#     done

#     echo "âœ… ëª¨ë“  'hermes' íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤."

#     # ìµœì¢… í™•ì¸
#     echo "ğŸ” ìµœì¢… í™•ì¸:"
#     for file in $TARGET_HERMES_FILES; do
#         FILE_SIZE=$(stat -f%z "$file")
#         ARCHITECTURES=$(lipo -archs "$file" 2>/dev/null || echo "Unknown")
#         echo "  Path: $file"
#         echo "  Size: ${FILE_SIZE} bytes"
#         echo "  Arch: ${ARCHITECTURES}"
#     done
#   displayName: '[ì¤‘ìš”] Replace ARM64 Hermes Files in Pods'

# - script: |
#     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
#     mkdir -p "$EXPORT_DIR"
    
#     cat << EOF > "$EXPORT_DIR/ExportOptions.plist"
#     <?xml version="1.0" encoding="UTF-8"?>
#     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
#     <plist version="1.0">
#     <dict>
#         <key>method</key>
#         <string>app-store</string>
#         <key>teamID</key>
#         <string>${{ parameters.TEAM_ID }}</string>
#         <key>provisioningProfiles</key>
#         <dict>
#             <key>$BUNDLE_ID</key>
#             <string>${{ parameters.PROVISIONING_PROFILE_NAME }}</string>
#         </dict>
#     </dict>
#     </plist>
#     EOF
    
#     echo "ExportOptions.plist created with provisioningProfiles and bundle ID."
#     cat "$EXPORT_DIR/ExportOptions.plist"  # Output the created plist content for debugging

#   displayName: 'Generate ExportOptions.plist'

# - script: |
#     echo "Creating Bridging Header..."
#     cat > ios/Azure_RN078-Bridging-Header.h << 'EOF'
#     #import <React/RCTBridgeModule.h>
#     #import <React/RCTBridge.h>
#     #import <React/RCTEventDispatcher.h>
#     #import <React/RCTRootView.h>
#     #import <React/RCTUtils.h>
#     #import <React/RCTConvert.h>
#     #import <React/RCTBundleURLProvider.h>
#     EOF
    
#     echo "Updating project file with sed instead of plutil..."
#     cd ios
#     sed -i '' 's|SWIFT_OBJC_BRIDGING_HEADER = .*;|SWIFT_OBJC_BRIDGING_HEADER = "Azure_RN078-Bridging-Header.h";|g' Azure_RN078.xcodeproj/project.pbxproj || echo "Sed command failed, will use direct reference in build command instead"
#     cd ..
#   displayName: 'Setup Bridging Header with sed'

# - script: |
#     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
#     ARCHIVE_PATH="$EXPORT_DIR/${APP_NAME}.xcarchive"
    
#     # 1. .xcworkspace ì¡´ì¬ í™•ì¸
#     WORKSPACE_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}.xcworkspace"
#     if [ ! -d "$WORKSPACE_PATH" ]; then
#         echo "##vso[task.logissue type=error] .xcworkspace not found: $WORKSPACE_PATH"
#         exit 1
#     fi

#     rm -rf ~/Library/Developer/Xcode/DerivedData
#     rm -rf ios/Pods
#     pod cache clean --all
  
#     # 2. ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
#     cd ios
#     xcodebuild clean archive \
#       -workspace "${APP_NAME}.xcworkspace" \
#       -scheme "${APP_NAME}" \
#       -sdk iphoneos \
#       -configuration Release \
#       clean archive \
#       CODE_SIGN_IDENTITY="Apple Distribution" \
#       CODE_SIGN_STYLE="Manual" \
#       CODE_SIGN_IDENTITY="Apple Distribution" \
#       DEVELOPMENT_TEAM="${{ parameters.TEAM_ID }}" \
#       PROVISIONING_PROFILE_SPECIFIER="${{ parameters.PROVISIONING_PROFILE_NAME }}" \
#       SWIFT_OBJC_BRIDGING_HEADER="Azure_RN078-Bridging-Header.h" \
#       -archivePath "$(Build.ArtifactStagingDirectory)/${APP_NAME}.xcarchive"

#     # 3. IPA ë‚´ë³´ë‚´ê¸°
#     xcodebuild -exportArchive \
#       -archivePath "$ARCHIVE_PATH" \
#       -exportOptionsPlist "$EXPORT_DIR/ExportOptions.plist" \
#       -exportPath "$EXPORT_DIR"
    
#     echo "IPA exported to: $EXPORT_DIR"
#   displayName: 'Build and Export IPA'

# # - script: |
# #     echo "ğŸ” IPA íŒŒì¼ ë‚´ Hermes íŒŒì¼ êµì²´ ì‘ì—… ì‹œì‘..."

# #     # ê²½ë¡œ ì„¤ì •
# #     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
# #     IPA_PATH=$(find "$EXPORT_DIR" -type f -name "*.ipa" | head -n 1)
# #     EXTRACT_DIR="$EXPORT_DIR/extracted_ipa"
# #     REPACKED_IPA="$EXPORT_DIR/repacked_app.ipa"
# #     APP_SEALING_SDK_DIR="$(Build.SourcesDirectory)/ios/AppSealingSDK"

# #     # 1. IPA íŒŒì¼ ì¶”ì¶œ
# #     echo "ğŸ“¦ IPA ì¶”ì¶œ: $IPA_PATH -> $EXTRACT_DIR"
# #     rm -rf "$EXTRACT_DIR"
# #     unzip -q "$IPA_PATH" -d "$EXTRACT_DIR"

# #     # ë””ë²„ê¹…: ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥
# #     echo "ğŸ” ì¶”ì¶œëœ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
# #     find "$EXTRACT_DIR" -type d | sed 's/^/  /'

# #     # 2. Hermes íŒŒì¼ ê²€ìƒ‰ (ì •í™•í•œ ì´ë¦„ê³¼ ëŒ€ì†Œë¬¸ì êµ¬ë¶„)
# #     echo "ğŸ” Hermes íŒŒì¼ ê²€ìƒ‰ ì‹œì‘..."
# #     HERMES_FILES=$(find "$EXTRACT_DIR" -type f -name "hermes" 2>/dev/null)

# #     # ë””ë²„ê¹…: ë°œê²¬ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
# #     echo "ğŸ” ë°œê²¬ëœ Hermes íŒŒì¼ ëª©ë¡:"
# #     echo "$HERMES_FILES" | sed 's/^/  /'

# #     if [ -z "$HERMES_FILES" ]; then
# #         echo "âŒ ì¶”ì¶œëœ IPAì—ì„œ Hermes íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
# #         exit 1
# #     fi

# #     # 3. íŒŒì¼ êµì²´
# #     for TARGET_FILE in $HERMES_FILES; do
# #         FILENAME=$(basename "$TARGET_FILE")
# #         SOURCE_FILE=$(find "$APP_SEALING_SDK_DIR" -name "$FILENAME" -type f 2>/dev/null)

# #         if [ -n "$SOURCE_FILE" ]; then
# #             echo "ğŸ”„ êµì²´: $TARGET_FILE"
# #             cp -fv "$SOURCE_FILE" "$TARGET_FILE" || echo "âš ï¸  ì‹¤íŒ¨: $FILENAME"
            
# #             # ê²€ì¦: íŒŒì¼ í¬ê¸° ë¹„êµ
# #             TARGET_SIZE=$(stat -f%z "$TARGET_FILE")
# #             SOURCE_SIZE=$(stat -f%z "$SOURCE_FILE")
# #             echo "  ì†ŒìŠ¤ í¬ê¸°: ${SOURCE_SIZE} ë°”ì´íŠ¸"
# #             echo "  ëŒ€ìƒ í¬ê¸°: ${TARGET_SIZE} ë°”ì´íŠ¸"
# #         else
# #             echo "â© ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ: $FILENAME"
# #         fi
# #     done

# #     # 4. ì¬ì••ì¶•
# #     echo "ğŸ“¦ ì¬ì••ì¶•: $REPACKED_IPA"
# #     cd "$EXTRACT_DIR"
# #     zip -qr "$REPACKED_IPA" ./*
    
# #     echo "âœ… Hermes íŒŒì¼ êµì²´ ì™„ë£Œ!"
# #   displayName: '[ì¤‘ìš”] IPA ë‚´ Hermes íŒŒì¼ êµì²´ ë° ê²€ì¦'

# - script: |
#     # Grant execution permission to generate_hash script
#     HASH_SCRIPT_PATH="$(Build.SourcesDirectory)/ios/AppSealingSDK/generate_hash"
#     # echo "-------------------------------------"
#     # cd "$(Build.SourcesDirectory)/ios/AppSealingSDK"
#     # ls -al
#     # echo "-------------------------------------"
#     EXPORT_DIR="$(Build.ArtifactStagingDirectory)"
#     # cd "$EXPORT_DIR"
#     # ls -al
#     # echo "-------------------------------------"
#     IPA_PATH=$(find "$EXPORT_DIR" -type f -name "*.ipa" | head -n 1)

#     echo "Granting execution permission to generate_hash..."
#     chmod +x "$HASH_SCRIPT_PATH"

#     echo "Running generate_hash with IPA... $IPA_PATH"
#     "$HASH_SCRIPT_PATH" "$IPA_PATH"
#   displayName: 'Run generate_hash on IPA'

# - script: |
#     # Upload the IPA file to TestFlight using altool
#     IPA_PATH=$(find "$(Build.ArtifactStagingDirectory)" -type f -name "*.ipa" | head -n 1)

#     if [ -f "$IPA_PATH" ]; then
#         xcrun altool --upload-app \
#           -f "$IPA_PATH" \
#           -t ios \
#           -u "${{ parameters.APPLE_ID }}" \
#           -p "${{ parameters.APP_SPECIFIC_PASSWORD }}"

#         echo "Uploaded IPA to TestFlight successfully."
#     else
#         echo "IPA file not found. Skipping upload."
#         exit 1
#     fi
#   displayName: 'Upload to TestFlight'

# - script: |
#     # Cleanup temporary keychain and build artifacts
#     TEMP_KEYCHAIN_PATH="$HOME/Library/Keychains/temp-keychain.keychain-db"

#     if [ -f "$TEMP_KEYCHAIN_PATH" ]; then
#         security delete-keychain "$TEMP_KEYCHAIN_PATH"
#         echo "Temporary keychain deleted successfully."
#     else
#         echo "Temporary keychain not found. Skipping deletion."
#     fi

#     rm -rf "$(Build.ArtifactStagingDirectory)" ios/build ios/Pods ios/Podfile.lock

#     echo "Cleanup completed."
#   displayName: 'Cleanup Temporary Files'

  - task: UseNode@1
    inputs:
      version: '18.x'
    displayName: 'Install Node.js'

  - script: |
      echo "Installing JS dependencies..."
      yarn install --frozen-lockfile
    displayName: 'Install Node Modules'

  - script: |
      echo "Installing dependencies..."
      brew install cocoapods
      gem pristine ffi --version 1.16.3
      cd ios
      pod install
    displayName: 'Install CocoaPods'

  - script: |
      # React Native iOS ì•± ì´ë¦„ ìë™ ê°ì§€
      if [ -d "ios" ]; then
          APP_NAME=$(ls ios | grep ".xcodeproj" | sed 's/.xcodeproj//')
          if [ -z "$APP_NAME" ]; then
              echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ì—ì„œ Xcode í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
          fi
          echo "ê°ì§€ëœ ì•± ì´ë¦„: $APP_NAME"
      else
          echo "##vso[task.logissue type=error] iOS ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
          exit 1
      fi
      
      # Info.plist ê²½ë¡œ
      INFO_PLIST_PATH="$(Build.SourcesDirectory)/ios/${APP_NAME}/Info.plist"
      echo "Info.plist í™•ì¸ ê²½ë¡œ: $INFO_PLIST_PATH"

      # 1. Info.plistì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
      if [ -f "$INFO_PLIST_PATH" ]; then
          echo "Info.plist ë°œê²¬. CFBundleIdentifier ì¶”ì¶œ ì¤‘..."
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST_PATH" 2>/dev/null)
          
          # ë³€ìˆ˜ ê°’ì´ í¬í•¨ë˜ì–´ ìˆê±°ë‚˜ ë¹ˆ ê°’ì¸ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ
          if [[ "$BUNDLE_ID" == *"$"* ]] || [ -z "$BUNDLE_ID" ]; then
              echo "ë³€ìˆ˜ ê°ì§€ ë˜ëŠ” ë¹ˆ ê°’. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ PRODUCT_BUNDLE_IDENTIFIER ê²€ìƒ‰..."
              
              # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
              if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
                  echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
                  BUNDLE_ID=$(xcodebuild -showBuildSettings \
                              -workspace "ios/${APP_NAME}.xcworkspace" \
                              -scheme "${APP_NAME}" \
                              -configuration Release \
                              -sdk iphoneos 2>/dev/null |
                              grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                              awk -F '=' '{print $2}' |
                              sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              else
                  echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
                  BUNDLE_ID=$(xcodebuild -showBuildSettings \
                              -project "ios/${APP_NAME}.xcodeproj" \
                              -scheme "${APP_NAME}" \
                              -configuration Release \
                              -sdk iphoneos 2>/dev/null |
                              grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                              awk -F '=' '{print $2}' |
                              sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              fi
          fi
      else
          # 2. Info.plist ì—†ì„ ê²½ìš° Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì§ì ‘ ì¶”ì¶œ
          echo "Info.plist ì—†ìŒ. Xcode ë¹Œë“œ ì„¤ì •ì—ì„œ ì¶”ì¶œ..."
          
          # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ í™•ì¸
          if [ -f "ios/${APP_NAME}.xcworkspace" ]; then
              echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcworkspace"
              BUNDLE_ID=$(xcodebuild -showBuildSettings \
                          -workspace "ios/${APP_NAME}.xcworkspace" \
                          -scheme "${APP_NAME}" \
                          -configuration Release \
                          -sdk iphoneos 2>/dev/null |
                          grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                          awk -F '=' '{print $2}' |
                          sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          else
              echo "í”„ë¡œì íŠ¸ íŒŒì¼ ì‚¬ìš©: ios/${APP_NAME}.xcodeproj"
              BUNDLE_ID=$(xcodebuild -showBuildSettings \
                          -project "ios/${APP_NAME}.xcodeproj" \
                          -scheme "${APP_NAME}" \
                          -configuration Release \
                          -sdk iphoneos 2>/dev/null |
                          grep -E '^\s*PRODUCT_BUNDLE_IDENTIFIER\s*=' |
                          awk -F '=' '{print $2}' |
                          sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          fi
      fi

      # 3. ì—¬ì „íˆ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° pbxproj íŒŒì¼ì—ì„œ ì§ì ‘ ê²€ìƒ‰
      if [ -z "$BUNDLE_ID" ]; then
          echo "ë¹Œë“œ ì„¤ì •ì—ì„œ ë²ˆë“¤ IDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. pbxproj íŒŒì¼ì—ì„œ ê²€ìƒ‰..."
          PBXPROJ_PATH="ios/${APP_NAME}.xcodeproj/project.pbxproj"
          if [ -f "$PBXPROJ_PATH" ]; then
              BUNDLE_ID=$(grep -A 5 "PRODUCT_BUNDLE_IDENTIFIER" "$PBXPROJ_PATH" | 
                        grep -o '"[^"]*"' | 
                        head -1 | 
                        sed 's/"//g')
          fi
      fi

      # ìµœì¢… ê²€ì¦
      if [ -z "$BUNDLE_ID" ]; then
          echo "##vso[task.logissue type=error] ë²ˆë“¤ ì‹ë³„ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
      fi

      echo "ì¶”ì¶œëœ BUNDLE_ID: $BUNDLE_ID"
      echo "##vso[task.setvariable variable=BUNDLE_ID]$BUNDLE_ID"
      echo "##vso[task.logissue type=warning] ì¶”ì¶œëœ Bundle ID: $BUNDLE_ID"
    displayName: 'Extract Bundle ID from React Native iOS Project'

  - script: |
      echo "Cleaning and building..."
      xcodebuild clean -workspace $WORKSPACE -scheme $SCHEME -configuration $CONFIGURATION
      xcodebuild archive \
        -workspace $WORKSPACE \
        -scheme $SCHEME \
        -sdk $SDK \
        -configuration $CONFIGURATION \
        -archivePath build/$SCHEME.xcarchive \
        CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
        DEVELOPMENT_TEAM=$TEAM_ID \
        PRODUCT_BUNDLE_IDENTIFIER=$BUNDLE_ID
    displayName: 'Archive iOS App'

  - script: |
      echo "Exporting .ipa..."
      xcodebuild -exportArchive \
        -archivePath build/$SCHEME.xcarchive \
        -exportOptionsPlist $EXPORT_OPTIONS_PLIST \
        -exportPath build/export
    displayName: 'Export IPA'

  - script: |
      echo "Uploading to TestFlight..."
      xcrun altool --upload-app \
        --type ios \
        --file build/export/$SCHEME.ipa \
        --username "$APPLE_ID" \
        --password "$APP_SPECIFIC_PASSWORD"
    displayName: 'Upload to TestFlight'